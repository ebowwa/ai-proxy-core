<!DOCTYPE html>
<html>
<head>
    <title>Debug Gemini WebSocket</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .message { margin: 5px 0; }
        .user { color: blue; }
        .assistant { color: green; }
        .error { color: red; }
        .system { color: gray; }
        input { width: 300px; padding: 5px; }
        button { padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>Debug Gemini WebSocket Test</h1>
    <div id="messages"></div>
    <input type="text" id="input" placeholder="Type message..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    
    <script>
        let ws = null;
        
        function log(msg, type = 'system') {
            const div = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.appendChild(msgDiv);
            div.scrollTop = div.scrollHeight;
        }
        
        function connect() {
            log('Connecting to WebSocket...');
            ws = new WebSocket('ws://localhost:8001/test');
            
            ws.onopen = () => {
                log('WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received:', data);
                    
                    if (data.status) {
                        log(`Status: ${data.status}`, 'system');
                    } else if (data.type === 'response') {
                        log(`Gemini: ${data.text}`, 'assistant');
                    } else if (data.error) {
                        log(`Error: ${data.error}`, 'error');
                    } else {
                        log(`Unknown: ${JSON.stringify(data)}`, 'system');
                    }
                } catch (e) {
                    log(`Parse error: ${e}`, 'error');
                }
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                log('WebSocket disconnected', 'system');
                ws = null;
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            
            if (!text || !ws) return;
            
            log(`You: ${text}`, 'user');
            
            ws.send(JSON.stringify({
                type: 'text',
                text: text
            }));
            
            input.value = '';
        }
        
        document.getElementById('input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>